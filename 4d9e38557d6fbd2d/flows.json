[{"id":"4d9e38557d6fbd2d","type":"tab","label":"[.core] support JS hash naming in variable access","disabled":false,"info":"## Hash naming\n\nJavascript supports array-like access to object variables:\n\n```\nkey.key2[\"key-three-minus\"]\n```\n\nwhich is the equivalent to \n\n```\nkey.key2.key-three-minus\n```\n\nBut since `-` is not allowed in variable names nor in keynames when using dot-notation, JS invented the array-like accessing of keynames with minus and other special characters.\n\nSince objects attributes can definitely contain minus & spaces & all liquorice sorts.\n\n## Workaround\n\nUntil this is implemented, the <a class=\"ahl-node-only\" data-ids=\"607f5f9390cebd42\">function 2</a> node provides a workaround by using Erlang code to access the map data directly.\n\n## Atom v. Binary key names\n\nSince Erlang uses atoms, binaries and lists as key names (well strictly speaking not Erlang rather Erlang-Red), there is a convention to allow for this:\n\n- `atom[\"binary\"]['atom2']`\n\nthat is, keys without out quotes are atoms, those with square-brackets and quotes are either binary or atom, depending on the quote symbol used.\n\n- `\"binary\".atom`\n- `'123-atom-name'[\"binary\"]`\n\nStarting with a quote is also allowed and is either a binary key name or an atom key name.\n\nStarting with a bracket is not allowed since the prefix is `msg.` - the dot cannot be followed by a square bracket.\n\n## Property name handling\n\nThe handling of property references is now done with a parser which attempts to handle most use-cases of Javascript accessing of object properties.\n\n- [erlang_red_attr_leex.xrl](https://github.com/gorenje/erlang-red/blob/main/src/erlang_red_attr_leex.xrl)\n- [erlang_red_attr_parser.yrl](https://github.com/gorenje/erlang-red/blob/d75ebec922a8494ab7adbf2ce220e831a2ec6133/src/erlang_red_attr_parser.yrl)\n- [attribute_parser_test.erl](https://github.com/gorenje/erlang-red/blob/d75ebec922a8494ab7adbf2ce220e831a2ec6133/test/attribute_parser_test.erl)\n\nThe test also demonstrates the conversion between atom and binary in the keynames, and what conventions are used.\n\n","env":[{"name":"ERED_PENDING","value":"false","type":"bool"}]},{"id":"5abd420aeac80657","type":"function","z":"4d9e38557d6fbd2d","name":"function 1","func":"maps:put(req, \n#{cookies =>\n[{<<\"wsname\">>,<<\"none\">>}],\nparams => #{},\nuri => <<\"http://red-erik.org/\">>,\nquery => #{},body => <<>>,\nheaders =>\n#{<<\"accept\">> =>\n<<\"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\">>,\n<<\"accept-encoding\">> =>\n<<\"gzip, deflate, br, zstd\">>,\n<<\"accept-language\">> =>\n<<\"en-GB,en;q=0.5\">>,\n<<\"cookie\">> =>\n<<\"wsname=none\">>,\n<<\"dnt\">> => <<\"1\">>,\n<<\"host\">> =>\n<<\"red-erik.org\">>,\n<<\"priority\">> => <<\"u=0, i\">>,\n<<\"sec-fetch-dest\">> =>\n<<\"document\">>,\n<<\"sec-fetch-mode\">> =>\n<<\"navigate\">>,\n<<\"sec-fetch-site\">> =>\n<<\"cross-site\">>,\n<<\"server\">> => <<\"Heroku\">>,\n<<\"upgrade-insecure-requests\">> =>\n<<\"1\">>,\n<<\"user-agent\">> =>\n<<\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:128.0) Gecko/20100101 Firefox/128.0\">>,\n<<\"via\">> =>\n<<\"2.0 heroku-router\">>,\n<<\"x-forwarded-for\">> =>\n<<\"46.142.30.68\">>,\n<<\"x-forwarded-port\">> =>\n<<\"443\">>,\n<<\"x-forwarded-proto\">> =>\n<<\"https\">>,\n<<\"x-request-id\">> =>\n<<\"f0c743fc-00d0-b6d3-360c-07a4b99cfc88\">>,\n<<\"x-request-start\">> =>\n<<\"1749713466544\">>},\nmethod => <<\"GET\">>,\npara1 => #{ <<\"para2\">> => #{ <<\"para3\">> => #{ <<\"para4\">> => <<\"hwllo\">> } } },\n<<\"para2\">> => #{ <<\"para2\">> => #{ <<\"para3\">> => #{ <<\"para4\">> => <<\"hwllo\">> } } },\nurl => <<\"/content/somethng.gif\">>},\nMsg)","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":617,"y":596.0833778381348,"wires":[["fa2f1e130cd3daeb","f5fe516234a15e40"]]},{"id":"20c58f12f652e7ef","type":"inject","z":"4d9e38557d6fbd2d","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":300.66668701171875,"y":880.0000400543213,"wires":[["5abd420aeac80657","1d9829e1c0a1b320","093480123e9d894d","5421d5f8cbd4b262","395d57936442bd73","20667b707cf94b29","23b0e895db233e76","07bce275994c9f0a","bbf152d6a45300f1"]]},{"id":"fa2f1e130cd3daeb","type":"change","z":"4d9e38557d6fbd2d","name":"handle a mix of atom and binary key names","rules":[{"t":"set","p":"host","pt":"msg","to":"req.headers[\"host\"]","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1066,"y":515.7083740234375,"wires":[["1b5de5ce9dd8899a"]]},{"id":"1b5de5ce9dd8899a","type":"ut-assert-values","z":"4d9e38557d6fbd2d","name":"","rules":[{"t":"eql","p":"host","pt":"msg","to":"red-erik.org","tot":"str"}],"x":1389.6666984558105,"y":515.7083740234375,"wires":[[]]},{"id":"f5fe516234a15e40","type":"function","z":"4d9e38557d6fbd2d","name":"retrieve schema & host","func":"Msg2 = ered_header_retrieve:get_key(<<\"x-forwarded-proto\">>, schema, Msg),\nered_header_retrieve:get_key(<<\"host\">>, host, Msg2)\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":996,"y":596.0833778381348,"wires":[["7d948996aba2be3d"]]},{"id":"7d948996aba2be3d","type":"ut-assert-values","z":"4d9e38557d6fbd2d","name":"","rules":[{"p":"host","pt":"msg","t":"eql","to":"red-erik.org","tot":"str"},{"p":"schema","pt":"msg","t":"eql","to":"https","tot":"str"}],"x":1389.6666984558105,"y":596.0833778381348,"wires":[[]]},{"id":"3a871b9f9224c8c3","type":"erlmodule","z":"4d9e38557d6fbd2d","name":"","module_name":"ered_header_retrieve","code":"-module(ered_header_retrieve).\n\n-export([get_key/3]).\n\nget_key(Keyname, AttrName, Msg) ->\n    case maps:find(req, Msg) of\n    {ok, D} ->\n        case maps:find(headers, D) of \n            {ok, H} ->\n                case maps:find(Keyname,H) of  \n                    {ok, S} ->\n                        maps:put(AttrName, S, Msg);\n                    _ -> \n                        Msg\n                end;\n            _ ->\n                Msg\n            end;\n        _ ->\n        Msg\n    end.","x":657,"y":515.7083740234375,"wires":[]},{"id":"a3bfd9f9f51b9275","type":"ut-assert-values","z":"4d9e38557d6fbd2d","name":"","rules":[{"t":"eql","p":"topic","pt":"msg","to":"one","tot":"str"}],"x":1389.6666984558105,"y":816,"wires":[[]]},{"id":"1d9829e1c0a1b320","type":"change","z":"4d9e38557d6fbd2d","name":"","rules":[{"t":"set","p":"Key","pt":"msg","to":"{ \"dd\": { \"Fubar\": \"one\" }}","tot":"json"},{"t":"set","p":"topic","pt":"msg","to":"Key.dd.Fubar","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":976,"y":816,"wires":[["a3bfd9f9f51b9275"]]},{"id":"1219a0274ad671fe","type":"change","z":"4d9e38557d6fbd2d","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"abcd['a121'].b2['c4'].d5['e6'].f7['g8'].h9['i10']","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":976,"y":896.333251953125,"wires":[["d26f3eff4b844e56"]]},{"id":"093480123e9d894d","type":"function","z":"4d9e38557d6fbd2d","name":"abcd ==> ... ==> i10","func":"Msg#{ abcd => #{\n            a121 => #{\n                    b2 => #{\n                          c4 => #{\n                                d5 => #{\n                                      e6 => #{\n                                            f7 => #{\n                                                  g8 => #{\n                                                        h9  => #{ \n                                                               i10 => <<\"hello world\">>\n                                                                }\n                                                        }\n                                                  }\n                                            }\n                                       }\n                                 }\n                          }\n                  }\n          }\n    }","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":657,"y":896.333251953125,"wires":[["1219a0274ad671fe"]]},{"id":"8aea784fd48c0119","type":"change","z":"4d9e38557d6fbd2d","name":"'ddd'[\"eee\"].de","rules":[{"t":"set","p":"payload","pt":"msg","to":"'ddd'[\"eee\"].de","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":976,"y":971.666748046875,"wires":[["e9c0c1a316434d37"]]},{"id":"d26f3eff4b844e56","type":"ut-assert-values","z":"4d9e38557d6fbd2d","name":"","rules":[{"t":"eql","p":"payload","pt":"msg","to":"hello world","tot":"str"}],"x":1399.6666984558105,"y":896.333251953125,"wires":[[]]},{"id":"f08d8ca7d1a9698a","type":"change","z":"4d9e38557d6fbd2d","name":"'ddd'.de","rules":[{"t":"set","p":"payload","pt":"msg","to":"'ddd'.de","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":956,"y":714.3334350585938,"wires":[["bca927a8bc41c590"]]},{"id":"5421d5f8cbd4b262","type":"function","z":"4d9e38557d6fbd2d","name":"'ddd'.de","func":"Msg#{ ddd => #{ de => \"hello world\" } }","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":617,"y":714.3334350585938,"wires":[["f08d8ca7d1a9698a"]]},{"id":"bca927a8bc41c590","type":"ut-assert-values","z":"4d9e38557d6fbd2d","name":"","rules":[{"t":"eql","p":"payload","pt":"msg","to":"hello world","tot":"str"}],"x":1399.6666984558105,"y":714.3334350585938,"wires":[[]]},{"id":"e5c667483f073dca","type":"change","z":"4d9e38557d6fbd2d","name":"'ddd'.ddd.eee","rules":[{"t":"set","p":"payload","pt":"msg","to":"'ddd'.ddd.eee","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":976,"y":1076.3333740234375,"wires":[["87872796c5566c13"]]},{"id":"395d57936442bd73","type":"function","z":"4d9e38557d6fbd2d","name":"'ddd'[\"eee\"].de","func":"Msg#{ ddd => #{ <<\"eee\">> => #{ de => \"hello world\" } } }","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":637,"y":971.666748046875,"wires":[["8aea784fd48c0119"]]},{"id":"e9c0c1a316434d37","type":"ut-assert-values","z":"4d9e38557d6fbd2d","name":"","rules":[{"t":"eql","p":"payload","pt":"msg","to":"hello world","tot":"str"}],"x":1399.6666984558105,"y":971.666748046875,"wires":[[]]},{"id":"0dc07df7f8bcb117","type":"change","z":"4d9e38557d6fbd2d","name":"\"eee\".fff[\"ggg\"]","rules":[{"t":"set","p":"payload","pt":"msg","to":"\"eee\".fff[\"ggg\"]","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":976,"y":1150.6666870117188,"wires":[["4b960063268edb82"]]},{"id":"20667b707cf94b29","type":"function","z":"4d9e38557d6fbd2d","name":"'ddd'.ddd.eee","func":"Msg#{ ddd => #{ ddd => #{ eee => \"hello world\" } } }","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":637,"y":1076.3333740234375,"wires":[["e5c667483f073dca"]]},{"id":"87872796c5566c13","type":"ut-assert-values","z":"4d9e38557d6fbd2d","name":"","rules":[{"t":"eql","p":"payload","pt":"msg","to":"hello world","tot":"str"}],"x":1399.6666984558105,"y":1076.3333740234375,"wires":[[]]},{"id":"8027ccbeeb12bf68","type":"change","z":"4d9e38557d6fbd2d","name":"\"ddd\"[\"dd\"][\"ff\"][\"gg\"][\"hh\"]","rules":[{"t":"set","p":"payload","pt":"msg","to":"\"ddd\"[\"dd\"][\"ff\"][\"gg\"][\"hh\"]","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1016,"y":1232,"wires":[["cc53650fdfe3a6cb"]]},{"id":"e4e3b2db6e0a3bed","type":"change","z":"4d9e38557d6fbd2d","name":"'123-atom-name'[\"binary\"]","rules":[{"t":"set","p":"payload","pt":"msg","to":"'123-atom-name'[\"binary\"]","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1016,"y":1325,"wires":[["9957dc0194f2cd24"]]},{"id":"23b0e895db233e76","type":"function","z":"4d9e38557d6fbd2d","name":"\"eee\".fff[\"ggg\"]","func":"Msg#{ <<\"eee\">> => #{ fff => #{ <<\"ggg\">> => \"hello world\" } } }","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":637,"y":1150.6666870117188,"wires":[["0dc07df7f8bcb117"]]},{"id":"4b960063268edb82","type":"ut-assert-values","z":"4d9e38557d6fbd2d","name":"","rules":[{"t":"eql","p":"payload","pt":"msg","to":"hello world","tot":"str"}],"x":1399.6666984558105,"y":1150.6666870117188,"wires":[[]]},{"id":"07bce275994c9f0a","type":"function","z":"4d9e38557d6fbd2d","name":"\"ddd\"[\"dd\"][\"ff\"][\"gg\"][\"hh\"]","func":"Msg#{ <<\"ddd\">> => #{ <<\"dd\">> => #{ <<\"ff\">> => #{ <<\"gg\">> => #{ <<\"hh\">> => <<\"hello world\">> } } } } }","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":677,"y":1232,"wires":[["8027ccbeeb12bf68"]]},{"id":"cc53650fdfe3a6cb","type":"ut-assert-values","z":"4d9e38557d6fbd2d","name":"","rules":[{"t":"eql","p":"payload","pt":"msg","to":"hello world","tot":"str"}],"x":1399.6666984558105,"y":1232,"wires":[[]]},{"id":"bbf152d6a45300f1","type":"function","z":"4d9e38557d6fbd2d","name":"'123-atom-name'[\"binary\"]","func":"Msg#{ '123-atom-name' => #{ <<\"binary\">> => \"hello world\" } } ","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":677,"y":1325,"wires":[["e4e3b2db6e0a3bed"]]},{"id":"9957dc0194f2cd24","type":"ut-assert-values","z":"4d9e38557d6fbd2d","name":"","rules":[{"t":"eql","p":"payload","pt":"msg","to":"hello world","tot":"str"}],"x":1399.6666984558105,"y":1325,"wires":[[]]}]