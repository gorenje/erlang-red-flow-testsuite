[{"id":"6b22ce2a482c2d6d","type":"tab","label":"[supervisor] restart after exit call","disabled":false,"info":"<small><i>[Share Link](https://flows.red-erik.org/f/6b22ce2a482c2d6d)</i></small>\n\n## Restart supervisor via message\n\nHere the <a class=\"ahl-node-only\" data-ids=\"021e749ad389ab88\">supervisor</a> is supervising two function nodes, <a class=\"ahl-node-only\" data-ids=\"874cb18b3842747d\">one</a> of which exits each time it receives a message. The <a class=\"ahl-node-only\" data-ids=\"84927e2b99bfc27b\">second</a> function node passes the message through, unaltered.\n\nA <a class=\"ahl-group-only\" data-ids=\"eb4c717d536bec97\">message generator</a> sends both function nodes a continous stream of messages. Messages are five milliseconds apart, two hundred messages per second.\n\nThe configuration of the <a class=\"ahl-node-only\" data-ids=\"021e749ad389ab88\">supervisor</a> is intensity of 5 over a period of 30 seconds. Meaning the functions node can fail up to five times in a thirty second period.\n\nThe <a class=\"ahl-node-only\" data-ids=\"874cb18b3842747d\">exit call</a> function fails *each* time it receives a message, meaning it fails 5 times in 25 *milli*seconds, after 30 milliseconds the <a class=\"ahl-node-only\" data-ids=\"021e749ad389ab88\">supervisor</a> also fails, taking with it the second <a class=\"ahl-node-only\" data-ids=\"84927e2b99bfc27b\">function</a> node.\n\n\nThat is way the <a class=\"ahl-node-only\" data-ids=\"1ea63df69490f4db\">debug message counter</a> is incremented in blocks of six, because the <a class=\"ahl-node-only\" data-ids=\"84927e2b99bfc27b\">function 2</a> passes through the first six messages, then dies, gets restarted and passes through another six messages.\n\n![img](https://cdn.openmindmap.org/content/1748524763647_erlang-red-supervisor3.gif)\n\n\nWhen the <a class=\"ahl-node-only\" data-ids=\"021e749ad389ab88\">supervisor</a> fails, it sends a message to the <a class=\"ahl-node-only\" data-ids=\"29503cddc16de778\">what status?</a> switch node that, if the status of the supervisor is `dead` then directs the message along the <a class=\"ahl-group-only\" data-ids=\"e1a45cd7394adb90\">restart path</a>.\n\nThe message is <a class=\"ahl-node-only\" data-ids=\"efac69a788e070b5\">delayed by 2s</a> and the <a class=\"ahl-node-only\" data-ids=\"8277b19f347ddcfb\">set msg.action</a> to `restart` before being passed to the supervisor. It then restarts just to fail again after 30 milliseconds.\n\n## Supervisor to supervise a Supervisor\n\nIt is also possible to use a supervisor node to restart a supervisor, that is demonstrated by this [flow](https://flows.red-erik.org/f/e447b0048a5983b5).\n\n","env":[{"name":"ERED_TIMEOUT","value":"9","type":"num"},{"name":"ERED_NOT_EUNIT","value":"true","type":"bool"}]},{"id":"abf8c9a905272f8e","type":"group","z":"6b22ce2a482c2d6d","style":{"color":"#a4a4a4","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","stroke":"#999999","stroke-opacity":"1"},"nodes":["021e749ad389ab88","874cb18b3842747d","84927e2b99bfc27b"],"x":925,"y":404,"w":272,"h":528.5714285714286},{"id":"eb4c717d536bec97","type":"group","z":"6b22ce2a482c2d6d","name":"message generator","style":{"label":true},"nodes":["00404d33057120fb","b1e8a05edf9a1f49","fa84ecd4d8a1c08d"],"x":164,"y":746.75,"w":531,"h":190.25},{"id":"e1a45cd7394adb90","type":"group","z":"6b22ce2a482c2d6d","name":"restart path","style":{"label":true},"nodes":["efac69a788e070b5","8277b19f347ddcfb","b14c6de25717ff89","35f156dc1adffb2e"],"x":737.2055430412292,"y":191.22167646884918,"w":823.7129144668579,"h":154.77832353115082},{"id":"b14c6de25717ff89","type":"junction","z":"6b22ce2a482c2d6d","g":"e1a45cd7394adb90","x":763.2055430412292,"y":217.22167646884918,"wires":[["8277b19f347ddcfb"]]},{"id":"35f156dc1adffb2e","type":"junction","z":"6b22ce2a482c2d6d","g":"e1a45cd7394adb90","x":1534.9184575080872,"y":217.51034879684448,"wires":[["b14c6de25717ff89"]]},{"id":"021e749ad389ab88","type":"erlsupervisor","z":"6b22ce2a482c2d6d","g":"abf8c9a905272f8e","name":"supervisor of loving grace","scope":["874cb18b3842747d","84927e2b99bfc27b"],"supervisor_type":"static","strategy":"one_for_all","auto_shutdown":"never","intensity":"5","period":"30","child_type":"worker","child_restart":"permanent","child_shutdown":"infinite","child_shutdown_timeout":"","x":1061,"y":445,"wires":[["29503cddc16de778"]]},{"id":"874cb18b3842747d","type":"function","z":"6b22ce2a482c2d6d","g":"abf8c9a905272f8e","name":"exit call","func":"exit(self(), failure_of_func)","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1016,"y":787.75,"wires":[[]]},{"id":"84927e2b99bfc27b","type":"function","z":"6b22ce2a482c2d6d","g":"abf8c9a905272f8e","name":"function 2","func":"maps:put(hello, world, Msg)\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1016,"y":891.5714285714286,"wires":[["f09b0ccfab4ddbf7"]]},{"id":"00404d33057120fb","type":"inject","z":"6b22ce2a482c2d6d","g":"eb4c717d536bec97","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":270,"y":787.75,"wires":[["b1e8a05edf9a1f49"]]},{"id":"b1e8a05edf9a1f49","type":"change","z":"6b22ce2a482c2d6d","g":"eb4c717d536bec97","name":"","rules":[{"p":"payload","pt":"msg","t":"set","to":"","tot":"date"}],"action":"","property":"","from":"","to":"","reg":false,"x":589,"y":787.75,"wires":[["874cb18b3842747d","fa84ecd4d8a1c08d","ad82ec4cb4957dd2","84927e2b99bfc27b","f8fb4da6c8f33c06"]]},{"id":"fa84ecd4d8a1c08d","type":"delay","z":"6b22ce2a482c2d6d","g":"eb4c717d536bec97","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":592,"y":896,"wires":[["b1e8a05edf9a1f49"]]},{"id":"ad82ec4cb4957dd2","type":"debug","z":"6b22ce2a482c2d6d","name":"debug 5","active":true,"tosidebar":false,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"","statusType":"counter","x":795.7142715454102,"y":727.7143077850342,"wires":[]},{"id":"29503cddc16de778","type":"switch","z":"6b22ce2a482c2d6d","name":"what status?","property":"status","propertyType":"msg","rules":[{"t":"eq","v":"dead","vt":"str"},{"t":"eq","v":"started","vt":"str"},{"t":"eq","v":"restarted","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":1290,"y":445,"wires":[["5e74391f2b90b291","efac69a788e070b5","eaf756cb0b4d0e61"],["2c111f28540619e3"],["4a7406140d09ceb3"]]},{"id":"4a7406140d09ceb3","type":"debug","z":"6b22ce2a482c2d6d","name":"restarted counter","active":true,"tosidebar":false,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"","statusType":"counter","x":1617,"y":555,"wires":[]},{"id":"2c111f28540619e3","type":"debug","z":"6b22ce2a482c2d6d","name":"started counter","active":true,"tosidebar":false,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"","statusType":"counter","x":1607,"y":500,"wires":[]},{"id":"5e74391f2b90b291","type":"debug","z":"6b22ce2a482c2d6d","name":"dead counter","active":true,"tosidebar":false,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"","statusType":"counter","x":1597,"y":441,"wires":[]},{"id":"efac69a788e070b5","type":"delay","z":"6b22ce2a482c2d6d","g":"e1a45cd7394adb90","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":1453.4285888671875,"y":297.8571472167969,"wires":[["35f156dc1adffb2e"]]},{"id":"8277b19f347ddcfb","type":"change","z":"6b22ce2a482c2d6d","g":"e1a45cd7394adb90","name":"","rules":[{"p":"action","pt":"msg","t":"set","to":"restart","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":885.7142333984375,"y":305,"wires":[["021e749ad389ab88"]]},{"id":"7a6ae313d3d52f28","type":"ut-assert-success","z":"6b22ce2a482c2d6d","name":"","count":"0","x":803.7142944335938,"y":621.4285888671875,"wires":[]},{"id":"eaf756cb0b4d0e61","type":"ut-assert-success","z":"6b22ce2a482c2d6d","name":"","count":1,"x":1597,"y":384.5,"wires":[]},{"id":"f8fb4da6c8f33c06","type":"join","z":"6b22ce2a482c2d6d","name":"","mode":"custom","build":"array","property":"payload","propertyType":"full","key":"topic","joiner":"\\n","joinerType":"str","useparts":false,"accumulate":false,"timeout":"","count":"250","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":787,"y":681,"wires":[["7a6ae313d3d52f28"]]},{"id":"f09b0ccfab4ddbf7","type":"join","z":"6b22ce2a482c2d6d","name":"","mode":"custom","build":"array","property":"payload","propertyType":"full","key":"topic","joiner":"\\n","joinerType":"str","useparts":false,"accumulate":false,"timeout":"","count":"7","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":1270,"y":891.5714285714286,"wires":[["70857ba136d3d197"]]},{"id":"70857ba136d3d197","type":"ut-assert-failure","z":"6b22ce2a482c2d6d","name":"","x":1597,"y":891.5714285714286,"wires":[]}]